<!DOCTYPE html>
<html lang="en">
  <%- include('./components/head') %>
  <body>
    <div class="container">
      <%- include('./components/toolbar') %>
      <div class="content">
        <div class="editor-container">
          <%- include('./components/editor') %>
        </div>
        <%- include('./components/preview') %>
      </div>
    </div>

    <!-- Include scripts with proper tags -->
    <script src="<%= scriptUri %>/shared.js"></script>
    <script src="<%= scriptUri %>/editor.js"></script>
    <script src="<%= scriptUri %>/preview.js"></script>
    <script src="<%= scriptUri %>/toolbar.js"></script>

    <!-- Initialize mermaid and setup -->
    <script>
      window.mermaidText = `<%- mermaidText %>`;

      document.addEventListener("DOMContentLoaded", () => {
        mermaid.initialize({
          startOnLoad: false,
          securityLevel: "strict",
          logLevel: "error",
          theme: "default"
        });

        if (window.mermaidText) {
          updateDiagram(window.mermaidText);
          setTimeout(() => {
            if (window.fitToScreen) {
              window.fitToScreen();
            }
          }, 100);
        }

        window.addEventListener("message", (event) => {
          const message = event.data;
          switch (message.command) {
            case "update":
              if (message.text) {
                updateDiagram(message.text);
              }
              break;
            case "theme-change":
              mermaid.initialize({
                theme: message.theme === "dark" ? "dark" : "default",
                securityLevel: "strict"
              });
              updateDiagram(window.mermaidText);
              break;
          }
        });
      });
    </script>
  </body>
</html>
